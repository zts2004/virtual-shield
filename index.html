<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚境火盾 - 安全文件访问系统</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- 引入科幻字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 背景Canvas -->
    <canvas id="bgCanvas"></canvas>

    <!-- 密码验证层 -->
    <div id="authLayer" class="auth-layer">
        <div class="auth-box">
            <h2>安全验证</h2>
            <input type="password" id="passwordInput" placeholder="请输入访问密码" maxlength="8">
            <button id="submitBtn">验证</button>
            <div id="errorMsg" class="error-msg"></div>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div id="mainContent" class="main-content hidden">
        <h1 class="title">虚境火盾</h1>
        <div class="button-container">
            <button class="cyber-btn" data-path="files/附件一">附件一</button>
            <button class="cyber-btn" data-path="files/附件二">附件二</button>
            <button class="cyber-btn" data-path="files/附件三">附件三</button>
            <button class="cyber-btn" data-path="files/附件四">附件四</button>
            <button class="cyber-btn" data-path="files/视频">视频</button>
        </div>
        
        <!-- 文件浏览器 -->
        <div id="fileExplorer" class="file-explorer hidden">
            <div class="file-explorer-header">
                <h2 id="currentPath">文件浏览器</h2>
                <button id="backBtn" class="cyber-btn small">返回</button>
            </div>
            <div id="fileList" class="file-list"></div>
        </div>

        <!-- 文件预览 -->
        <div id="filePreview" class="file-preview hidden">
            <div class="preview-header">
                <h3 id="previewFileName">文件预览</h3>
                <button id="closePreview" class="cyber-btn small">关闭</button>
            </div>
            <div id="previewContent" class="preview-content"></div>
        </div>
    </div>

    <script>
        // GitHub API配置
        const GITHUB_API_BASE = 'https://api.github.com/repos/zts2004/virtual-shield/contents/';
        const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/zts2004/virtual-shield/main/';

        // 密码验证相关变量
        let loginAttempts = 0;
        const MAX_ATTEMPTS = 3;
        const LOCK_TIME = 15000;
        let isLocked = false;

        // 获取当前日期密码
        function getCurrentPassword() {
            const now = new Date();
            return now.getFullYear().toString() +
                   String(now.getMonth() + 1).padStart(2, '0') +
                   String(now.getDate()).padStart(2, '0');
        }

        // 验证密码
        function validatePassword(password) {
            const currentPassword = getCurrentPassword();
            console.log('当前密码：', currentPassword);
            return password === currentPassword;
        }

        // 检查本地存储的验证状态
        function checkAuthStatus() {
            const authStatus = localStorage.getItem('authStatus');
            const authTime = localStorage.getItem('authTime');
            if (authStatus === 'true' && authTime) {
                const now = new Date().getTime();
                const authTimestamp = parseInt(authTime);
                if (now - authTimestamp < 24 * 60 * 60 * 1000) {
                    return true;
                }
            }
            return false;
        }

        // 显示主内容
        function showMainContent() {
            document.getElementById('authLayer').style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
            // 确保文件浏览器和预览窗口是隐藏的
            document.getElementById('fileExplorer').classList.add('hidden');
            document.getElementById('filePreview').classList.add('hidden');
        }

        // 获取文件列表
        async function fetchFileList(path) {
            try {
                const response = await fetch(GITHUB_API_BASE + path);
                if (!response.ok) throw new Error('获取文件列表失败');
                return await response.json();
            } catch (error) {
                console.error('获取文件列表错误:', error);
                return [];
            }
        }

        // 获取文件内容
        async function fetchFileContent(path) {
            try {
                const response = await fetch(GITHUB_RAW_BASE + path);
                if (!response.ok) throw new Error('获取文件内容失败');
                return await response.text();
            } catch (error) {
                console.error('获取文件内容错误:', error);
                return '无法加载文件内容';
            }
        }

        // 显示文件列表
        function displayFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-icon">${file.type === 'dir' ? '📁' : '📄'}</span>
                    <span class="file-name">${file.name}</span>
                `;
                
                item.addEventListener('click', async () => {
                    if (file.type === 'dir') {
                        const files = await fetchFileList(file.path);
                        displayFileList(files);
                        document.getElementById('currentPath').textContent = file.path;
                    } else {
                        const content = await fetchFileContent(file.path);
                        showFilePreview(file.name, content);
                    }
                });
                
                fileList.appendChild(item);
            });
        }

        // 显示文件预览
        function showFilePreview(fileName, content) {
            const preview = document.getElementById('filePreview');
            const previewFileName = document.getElementById('previewFileName');
            const previewContent = document.getElementById('previewContent');
            
            previewFileName.textContent = fileName;
            
            // 根据文件类型显示不同的预览
            if (fileName.match(/\.(jpg|jpeg|png|gif)$/i)) {
                previewContent.innerHTML = `<img src="${GITHUB_RAW_BASE}${fileName}" alt="${fileName}">`;
            } else if (fileName.match(/\.(mp4|webm)$/i)) {
                previewContent.innerHTML = `
                    <video controls>
                        <source src="${GITHUB_RAW_BASE}${fileName}" type="video/${fileName.split('.').pop()}">
                        您的浏览器不支持视频播放
                    </video>
                `;
            } else {
                previewContent.innerHTML = `<pre>${content}</pre>`;
            }
            
            preview.classList.remove('hidden');
        }

        // 初始化事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化界面状态
            const authLayer = document.getElementById('authLayer');
            const mainContent = document.getElementById('mainContent');
            const fileExplorer = document.getElementById('fileExplorer');
            const filePreview = document.getElementById('filePreview');

            // 确保所有界面初始都是隐藏的
            mainContent.classList.add('hidden');
            fileExplorer.classList.add('hidden');
            filePreview.classList.add('hidden');

            // 检查验证状态
            if (checkAuthStatus()) {
                showMainContent();
            } else {
                authLayer.style.display = 'flex';
            }

            const passwordInput = document.getElementById('passwordInput');
            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('errorMsg');
            const backBtn = document.getElementById('backBtn');
            const closePreview = document.getElementById('closePreview');

            // 返回按钮事件
            backBtn.addEventListener('click', () => {
                fileExplorer.classList.add('hidden');
                document.getElementById('filePreview').classList.add('hidden');
            });

            // 关闭预览按钮事件
            closePreview.addEventListener('click', () => {
                document.getElementById('filePreview').classList.add('hidden');
            });

            // 文件按钮点击事件
            document.querySelectorAll('.cyber-btn:not(.small)').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const path = btn.getAttribute('data-path');
                    if (path) {
                        const files = await fetchFileList(path);
                        fileExplorer.classList.remove('hidden');
                        document.getElementById('currentPath').textContent = path;
                        displayFileList(files);
                        // 确保文件预览窗口是隐藏的
                        document.getElementById('filePreview').classList.add('hidden');
                    }
                });
            });

            // 密码验证事件
            submitBtn.addEventListener('click', () => {
                if (isLocked) {
                    errorMsg.textContent = `系统已锁定，请等待${Math.ceil((LOCK_TIME - (Date.now() - lockStartTime)) / 1000)}秒`;
                    return;
                }

                const password = passwordInput.value;
                if (validatePassword(password)) {
                    localStorage.setItem('authStatus', 'true');
                    localStorage.setItem('authTime', Date.now().toString());
                    showMainContent();
                    // 确保文件浏览器和预览窗口是隐藏的
                    fileExplorer.classList.add('hidden');
                    document.getElementById('filePreview').classList.add('hidden');
                } else {
                    loginAttempts++;
                    errorMsg.textContent = `密码错误，剩余尝试次数：${MAX_ATTEMPTS - loginAttempts}`;
                    
                    if (loginAttempts >= MAX_ATTEMPTS) {
                        isLocked = true;
                        const lockStartTime = Date.now();
                        errorMsg.textContent = `系统已锁定，请等待15秒`;
                        setTimeout(() => {
                            isLocked = false;
                            loginAttempts = 0;
                            errorMsg.textContent = '';
                        }, LOCK_TIME);
                    }
                }
            });
        });

        // Canvas背景动画
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');

        // 设置Canvas尺寸
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 粒子系统
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }

            draw() {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // 创建粒子
        const particles = Array.from({ length: 100 }, () => new Particle());

        // 动画循环
        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html> 